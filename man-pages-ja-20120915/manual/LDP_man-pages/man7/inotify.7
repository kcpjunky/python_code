.\" t
.\" Hey Emacs! This file is -*- nroff -*- source.
.\"
.\" Copyright (C) 2006 Michael Kerrisk <mtk.manpages@gmail.com>
.\"
.\" Permission is granted to make and distribute verbatim copies of this
.\" manual provided the copyright notice and this permission notice are
.\" preserved on all copies.
.\"
.\" Permission is granted to copy and distribute modified versions of this
.\" manual under the conditions for verbatim copying, provided that the
.\" entire resulting derived work is distributed under the terms of a
.\" permission notice identical to this one.
.\"
.\" Since the Linux kernel and libraries are constantly changing, this
.\" manual page may be incorrect or out-of-date.  The author(s) assume no
.\" responsibility for errors or omissions, or for damages resulting from
.\" the use of the information contained herein.  The author(s) may not
.\" have taken the same level of care in the production of this manual,
.\" which is licensed free of charge, as they might when working
.\" professionally.
.\"
.\" Formatted or processed versions of this manual, if unaccompanied by
.\" the source, must acknowledge the copyright and authors of this work.
.\"
.\"*******************************************************************
.\"
.\" This file was generated with po4a. Translate the source file.
.\"
.\"*******************************************************************
.TH INOTIFY 7 2012\-04\-26 Linux "Linux Programmer's Manual"
.SH 名前
inotify \- ファイルシステムイベントを監視する
.SH 説明
\fIinotify\fP API はファイルシステムイベントを監視するための機構を提供する。 inotify
は個々のファイルやディレクトリを監視するのに使える。 ディレクトリを監視する場合、inotify はディレクトリ自身と
ディレクトリ内のファイルのイベントを返す。

以下のシステムコールがこの API と共に使用される: \fBinotify_init\fP(2)  (や \fBinotify_init1\fP(2)),
\fBinotify_add_watch\fP(2), \fBinotify_rm_watch\fP(2), \fBread\fP(2), \fBclose\fP(2).

\fBinotify_init\fP(2)  は inotify インスタンスを作成し、inotify インスタンスを参照する ファイルディスクリプタを返す。
もっと新しい \fBinotify_init1\fP(2)  も \fBinotify_init\fP(2)  と同様だが、いくつかの追加の機能が提供されている。

\fBinotify_add_watch\fP(2)  は inotify インスタンスに関連づけられた「監視対象 (watch) リスト」を操作する。
監視対象リストの各アイテム ("watch") は、 ファイルまたはディレクトリのパス名と、 そのパス名で参照されるファイルに対して
カーネルが監視する複数のイベントの集合を指定する。 \fBinotify_add_watch\fP(2)
は新しい監視アイテムの作成や既存の監視対象の変更ができる。 各監視対象は一意の「監視対象ディスクリプタ」を持つ。 これは監視対象を作成したときに
\fBinotify_add_watch\fP(2)  から返される整数である。

\fBinotify_rm_watch\fP(2)  は inotify の監視対象リストからアイテムを削除する。

inotify インスタンスを指している 全てのファイルディスクリプタがクローズされた場合、 その下層にあるオブジェクトとそのリソースは、
カーネルで再利用するために解放される。 関連が切られた監視対象は自動的に解放される。

どのようなイベントが起こっていたかを知るには、 アプリケーションで inotify ファイルディスクリプタを \fBread\fP(2)  すればよい。
これまでに何もイベントが起こっていない場合、 停止 (blocking) モードのファイルディスクリプタであれば、 少なくとも 1
つのイベントが起こるまで \fBread\fP(2)  は停止する (シグナルにより割り込まれなかった場合。
シグナルによる割り込みがあった場合、呼び出しはエラー \fBEINTR\fP で失敗する。 \fBsignal\fP(7)  参照)。

\fBread\fP(2)  が成功すると、以下の構造体を 1 つ以上含むバッファが返される:
.in +4n
.nf

.\" FIXME . The type of the 'wd' field should probably be "int32_t".
.\" I submitted a patch to fix this.  See the LKML thread
.\" "[patch] Fix type errors in inotify interfaces", 18 Nov 2008
.\" Glibc bug filed: http://sources.redhat.com/bugzilla/show_bug.cgi?id=7040
struct inotify_event {
    int      wd;       /* 監視対象ディスクリプタ */
    uint32_t mask;     /* イベントのマスク */
    uint32_t cookie;   /* 関連するイベント群を関連づける
                          一意なクッキー (rename(2) 用) */
    uint32_t len;      /* \(aqname\(aq フィールドのサイズ */
    char     name[];   /* NULL で終端された任意の名前 */
};
.fi
.in

\fIwd\fP はイベント発生の監視対象を指定する。 これは、前もって行われた \fBinotify_add_watch\fP(2)
呼び出しで返された監視対象ディスクリプタのうちの 1 つである。

\fImask\fP には発生したイベント (下記参照) を記述するためのビットが含まれる。

\fIcookie\fP は関連するイベントを関連づけるための一意な整数である。
現在のところ、この値は rename イベントに対してのみ使われており、
結果のペアである \fBIN_MOVE_FROM\fP と \fBIN_MOVE_TO\fP イベントを
アプリケーションで関連づけることができる。
他のイベント種別の場合には、 \fIcookie\fP は 0 に設定する。

\fIname\fP フィールドは監視しているディレクトリ内のファイルに対して イベントが返される場合のためにだけ存在する。
監視するディレクトリからのファイルの相対パス名を表す。 このパス名は NULL で終端され、 その後の読み込みで適切なアドレス境界に調整するために、
さらに NULL バイトが含まれる場合もある。

\fIlen\fP フィールドは NULL バイトを含む \fIname\fP の全てのバイト数を表す。
よって、 \fIinotify_event\fP 構造体のサイズは
\fIsizeof(struct inotify_event)+len\fP である。

\fBread\fP(2) に渡されたバッファが小さすぎて次のイベントに関する情報を返せ
ない場合の動作はカーネルのバージョンにより異なる。 2.6.21 より前のカー
ネルでは、 \fBread\fP(2) は 0 を返す。 2.6.21 以降のカーネルでは、
\fBread\fP(2) はエラー \fBEINVAL\fP で失敗する。
バッファサイズとして

    sizeof(struct inotify_event) + NAME_MAX + 1

を指定すれば、少なくとも 1 イベントで読み出しを行うには十分である。

.SS "inotify イベント"
\fBinotify_add_watch\fP(2)  の \fImask\fP 引き数と、inotify ファイル構造体を \fBread\fP(2)
したときに返される \fIinotify_event\fP 構造体の \fImask\fP フィールドは、ともに inotify イベントを識別するための
ビットマスクである。 以下のビットが \fBinotify_add_watch\fP(2)  を呼ぶときの \fImask\fP に指定可能であり、
\fBread\fP(2)  で返される \fImask\fP フィールドで返される:
.RS 4
.sp
.PD 0
.TP  18
\fBIN_ACCESS\fP
ファイルがアクセス (read) された。(*)
.TP 
\fBIN_ATTRIB\fP
メタデータが変更された。 メタデータとは、例えば、許可 (permission)、タイムスタンプ、拡張属性、 リンクカウント (Linux 2.6.25
以降)、UID、GID などである。(*)
.TP 
\fBIN_CLOSE_WRITE\fP
書き込みのためにオープンされたファイルがクローズされた。(*)
.TP 
\fBIN_CLOSE_NOWRITE\fP
書き込み以外のためにオープンされたファイルがクローズされた。(*)
.TP 
\fBIN_CREATE\fP
監視対象ディレクトリ内でファイルやディレクトリが作成された。(*)
.TP 
\fBIN_DELETE\fP
監視対象ディレクトリ内でファイルやディレクトリが削除された。(*)
.TP 
\fBIN_DELETE_SELF\fP
監視対象のディレクトリまたはファイル自身が削除された。
.TP 
\fBIN_MODIFY\fP
ファイルが修正された。(*)
.TP 
\fBIN_MOVE_SELF\fP
監視対象のディレクトリまたはファイル自身が移動された。
.TP 
\fBIN_MOVED_FROM\fP
ファイルが監視対象ディレクトリ外へ移動された。(*)
.TP 
\fBIN_MOVED_TO\fP
ファイルが監視対象ディレクトリ内へ移動された。(*)
.TP 
\fBIN_OPEN\fP
ファイルがオープンされた。(*)
.PD
.RE
.PP
ディレクトリを監視する場合、 上記でアスタリスク (*) を付けたイベントは、 そのディレクトリ内のファイルに対して発生する。 このとき
\fIinotify_event\fP 構造体で返される \fIname\fP フィールドは、ディレクトリ内のファイル名を表す。
.PP
\fBIN_ALL_EVENTS\fP マクロは上記のイベント全てのマスクとして定義される。 このマクロは \fBinotify_add_watch\fP(2)
を呼び出すときの \fImask\fP 引き数として使える。

さらに 2 つの便利なマクロがある。
\fBIN_MOVE\fP は IN_MOVED_FROM|IN_MOVED_TO と同じで、
\fBIN_CLOSE\fP は IN_CLOSE_WRITE|IN_CLOSE_NOWRITE と同じである。
.PP
その他にも以下のビットを \fBinotify_add_watch\fP(2)  を呼ぶときの \fImask\fP に指定できる:
.RS 4
.sp
.PD 0
.TP  18
\fBIN_DONT_FOLLOW\fP
\fIpathname\fP がシンボリックリンクである場合に辿らない。 (Linux 2.6.15 以降)
.TP 
\fBIN_EXCL_UNLINK\fP (Linux 2.6.36 以降)
.\" commit 8c1934c8d70b22ca8333b216aec6c7d09fdbd6a6
デフォルトでは、あるディレクトリの子ファイルに関するイベントを監視 (watch)
した際、ディレクトリからその子ファイルが削除 (unlink) された場合であっても
その子ファイルに対してイベントが生成される。このことは、アプリケーションに
よってはあまり興味のないイベントが大量に発生することにつながる (例えば、\fI/tmp\fP
を監視している場合、たくさんのアプリケーションが、すぐにその名前が削除される
一時ファイルをそのディレクトリにに作成する)。 \fBIN_EXCL_UNLINK\fP を指定すると
このデフォルトの動作を変更でき、監視対象のディレクトリから子ファイルが削除
された後に子ファイルに関するイベントが生成されなくなる。
.TP 
\fBIN_MASK_ADD\fP
\fIpathname\fP に対する監視マスクが既に存在する場合、 (マスクの置き換えではなく) イベントを追加 (OR) する。
.TP 
\fBIN_ONESHOT\fP
1 つのイベントについて \fIpathname\fP を監視し、 イベントが発生したら監視対象リストから削除する。
.TP 
\fBIN_ONLYDIR\fP (Linux 2.6.15 以降)
\fIpathname\fP がディレクトリの場合にのみ監視する。
.PD
.RE
.PP
以下のビットが \fBread\fP(2)  で返される \fImask\fP フィールドに設定される:
.RS 4
.sp
.PD 0
.TP  18
\fBIN_IGNORED\fP
監視対象が (\fBinotify_rm_watch\fP(2) により) 明示的に 削除された。もしくは (ファイルの削除、またはファイル
システムのアンマウントにより) 自動的に削除された。
.TP 
\fBIN_ISDIR\fP
このイベントの対象がディレクトリである。
.TP 
\fBIN_Q_OVERFLOW\fP
イベントキューが溢れた (このイベントの場合、\fIwd\fP は \-1 である)。
.TP 
\fBIN_UNMOUNT\fP
監視対象オブジェクトを含むファイルシステムがアンマウントされた。
.PD
.RE
.SS "/proc インターフェース"
以下のインターフェースは、inotify で消費される カーネルメモリの総量を制限するのに使用できる:
.TP 
\fI/proc/sys/fs/inotify/max_queued_events\fP
このファイルの値は、アプリケーションが \fBinotify_init\fP(2)  を呼び出すときに使用され、対応する inotify インスタンスについて
キューに入れられるイベントの数の上限を設定する。 この制限を超えたイベントは破棄されるが、 \fBIN_Q_OVERFLOW\fP イベントが常に生成される。
.TP 
\fI/proc/sys/fs/inotify/max_user_instances\fP
1 つの実ユーザ ID に対して生成できる inotify インスタンスの数の上限を指定する。
.TP 
\fI/proc/sys/fs/inotify/max_user_watches\fP
作成可能な監視対象の数の実 UID 単位の上限を指定する。
.SH バージョン
inotify は 2.6.13 の Linux カーネルに組込まれた。 これに必要なライブラリのインターフェースは、 glibc のバージョン 2.4
に追加された (\fBIN_DONT_FOLLOW\fP, \fBIN_MASK_ADD\fP, \fBIN_ONLYDIR\fP だけはバージョン 2.5
で追加された)。
.SH 準拠
inotify API は Linux 独自のものである。
.SH 注意
inotify ファイルディスクリプタは \fBselect\fP(2), \fBpoll\fP(2), \fBepoll\fP(7)  を使って監視できる。
イベントがある場合、ファイルディスクリプタは読み込み可能と通知する。

Linux 2.6.25 以降では、シグナル駆動 (signal\-driven) I/O の通知が inotify
ファイルディスクリプタについて利用可能である。 \fBfcntl\fP(2)  に書かれている (\fBO_ASYNC\fP フラグを設定するための)
\fBF_SETFL\fP, \fBF_SETOWN\fP, \fBF_SETSIG\fP の議論を参照のこと。 シグナルハンドラに渡される \fIsiginfo_t\fP
構造体は、以下のフィールドが設定される (\fIsiginfo_t\fP は \fBsigaction\fP(2)  で説明されている)。 \fIsi_fd\fP には
inotify ファイルディスクリプタ番号が、 \fIsi_signo\fP にはシグナル番号が、 \fIsi_code\fP には \fBPOLL_IN\fP が、
\fIsi_band\fP には \fBPOLLIN\fP が設定される。

inotify ファイルディスクリプタに対して 連続して生成される出力 inotify イベントが同一の場合 (\fIwd\fP, \fImask\fP,
\fIcookie\fP, \fIname\fP が等しい場合)、 前のイベントがまだ読み込まれていなければ、 連続するイベントが 1 つのイベントにまとめられる
(ただし「バグ」の節も参照のこと)。

inotify ファイルディスクリプタの読み込みで返されるイベントは、 順序付けられたキューになる。
従って、たとえば、あるディレクトリの名前を別の名前に変更した場合、 inotify ファイルディスクリプタについての正しい順番で
イベントが生成されることが保証される。

\fBFIONREAD\fP \fBioctl\fP(2)  は inotify ファイルディスクリプタから何バイト読み込めるかを返す。
.SS 制限と警告
inotify によるディレクトリの監視は再帰的に行われない: あるディレクトリ以下の
サブディレクトリを監視する場合、 監視対象を追加で作成しなければならない。
大きなディレクトリツリーの場合には、この作業にかなり時間がかかることがある。

inotify API では inotify イベントのきっかけとなったユーザやプロセスに関する
情報が提供されない。

イベントキューは溢れる場合があることに注意すること。この場合にはイベントは
失われてしまう。堅牢性が必要なアプリケーションでは、イベントが失われる可能性
を適切に扱う必要がある。

inotify API では影響が受けるファイルをファイル名で特定する。
しかしながら、アプリケーションが inotify イベントを処理する時点では、
そのファイル名がすでに削除されたり変更されたりしている可能性がある。

ディレクトリツリー全体を監視していて、そのツリー内に新しいサブディレクトリが
作成される場合、新しいサブディレクトリに対する watch を作成するまでに、
新しいファイルがそのサブディレクトリ内にすでに作成されている場合がある点に
注意すること。したがって、watch を追加した直後にサブディレクトリの内容を
スキャンしたいと思う場合もあるだろう。
.SH バグ
2.6.16 以前のカーネルでは \fBIN_ONESHOT\fP \fImask\fP フラグが働かない。

カーネル 2.6.25 より前では、 連続する同一のイベントを一つにまとめることを意図したコード (古い方のイベントがまだ読み込まれていない場合に、
最新の 2 つのイベントを一つにまとめられる可能性がある) が、 最新のイベントが「最も古い」読み込まれていないイベントとまとめられるか
をチェックするようになっていた。
.SH 関連項目
\fBinotify_add_watch\fP(2), \fBinotify_init\fP(2), \fBinotify_init1\fP(2),
\fBinotify_rm_watch\fP(2), \fBread\fP(2), \fBstat\fP(2),
\fIDocumentation/filesystems/inotify.txt\fP.
.SH この文書について
この man ページは Linux \fIman\-pages\fP プロジェクトのリリース 3.41 の一部
である。プロジェクトの説明とバグ報告に関する情報は
http://www.kernel.org/doc/man\-pages/ に書かれている。
